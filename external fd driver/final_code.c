/*
 * final_code.c
 *
 *  Created on: Mar 17, 2021
 *      Author: mostafa
 */


// Section: Included Files

#include "drv_canfdspi_api.h"
#include "drv_canfdspi_register.h"
#include "drv_canfdspi_defines.h"
#include "../spi/drv_spi.h"
#include "mcp25xxfd_demo_h2_rel/firmware/src/system_config.h"



// *****************************************************************************
// *****************************************************************************
// Section: Configuration


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

// *****************************************************************************
// *****************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************


// *****************************************************************************
// *****************************************************************************
// Section: CAN Transmit






//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************



//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************




//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

// Section: Transmit Event FIFO




//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************








//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************




int8_t DRV_CANFDSPI_TefEventOverflowClear(CANFDSPI_MODULE_ID index)
{
    int8_t spiTransferError = 0;
    uint16_t a = 0;

    // Read Interrupt Flags
    REG_CiTEFSTA ciTefSta;
    ciTefSta.word = 0;
    a = cREGADDR_CiTEFSTA;

    spiTransferError = DRV_CANFDSPI_ReadByte(index, a, &ciTefSta.byte[0]);
    if (spiTransferError) {
        return -1;
    }

    // Modify
    ciTefSta.byte[0] &= ~(CAN_TEF_FIFO_OVERFLOW_EVENT);

    // Write
    spiTransferError = DRV_CANFDSPI_WriteByte(index, a, ciTefSta.byte[0]);
    if (spiTransferError) {
        return -2;
    }

    return spiTransferError;
}


// *****************************************************************************
// *****************************************************************************


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************
// *****************************************************************************
// *****************************************************************************


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//
// *****************************************************************************
// *****************************************************************************
// Section: Miscellaneous

uint32_t DRV_CANFDSPI_DlcToDataBytes(CAN_DLC dlc)
{
    uint32_t dataBytesInObject = 0;

    Nop();
    Nop();

    if (dlc < CAN_DLC_12) {
        dataBytesInObject = dlc;
    } else {
        switch (dlc) {
            case CAN_DLC_12:
                dataBytesInObject = 12;
                break;
            case CAN_DLC_16:
                dataBytesInObject = 16;
                break;
            case CAN_DLC_20:
                dataBytesInObject = 20;
                break;
            case CAN_DLC_24:
                dataBytesInObject = 24;
                break;
            case CAN_DLC_32:
                dataBytesInObject = 32;
                break;
            case CAN_DLC_48:
                dataBytesInObject = 48;
                break;
            case CAN_DLC_64:
                dataBytesInObject = 64;
                break;
            default:
                break;
        }
    }

    return dataBytesInObject;
}

int8_t DRV_CANFDSPI_FifoIndexGet(CANFDSPI_MODULE_ID index,
        CAN_FIFO_CHANNEL channel, uint8_t* mi)
{
    int8_t spiTransferError = 0;
    uint16_t a = 0;

    // Read Status register
    uint8_t b = 0;
    a = cREGADDR_CiFIFOSTA + (channel * CiFIFO_OFFSET);
    a += 1; // byte[1]

    spiTransferError = DRV_CANFDSPI_ReadByte(index, a, &b);
    if (spiTransferError) {
        return -1;
    }

    // Update data
    *mi = b & 0x1f;

    return spiTransferError;
}


