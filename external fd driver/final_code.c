/*
 * final_code.c
 *
 *  Created on: Mar 17, 2021
 *      Author: mostafa
 */


// Section: Included Files

#include <driver/mcp25xxfd_driver/CanFD/drv_canfdspi_api.h>
#include <driver/mcp25xxfd_driver/CanFD/drv_canfdspi_defines.h>
#include <driver/mcp25xxfd_driver/CanFD/drv_canfdspi_register.h>

#include "../spi/drv_spi.h"
#include "mcp25xxfd_demo_h2_rel/firmware/src/system_config.h"



// *****************************************************************************
// *****************************************************************************
// Section: Configuration


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

// *****************************************************************************
// *****************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************


// *****************************************************************************
// *****************************************************************************
// Section: CAN Transmit






//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************



//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************




//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

// Section: Transmit Event FIFO




//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************








//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************




int8_t DRV_CANFDSPI_TefEventOverflowClear(CANFDSPI_MODULE_ID index)
{
    int8_t spiTransferError = 0;
    uint16_t a = 0;

    // Read Interrupt Flags
    REG_CiTEFSTA ciTefSta;
    ciTefSta.word = 0;
    a = cREGADDR_CiTEFSTA;

    spiTransferError = DRV_CANFDSPI_ReadByte(index, a, &ciTefSta.byte[0]);
    if (spiTransferError) {
        return -1;
    }

    // Modify
    ciTefSta.byte[0] &= ~(CAN_TEF_FIFO_OVERFLOW_EVENT);

    // Write
    spiTransferError = DRV_CANFDSPI_WriteByte(index, a, ciTefSta.byte[0]);
    if (spiTransferError) {
        return -2;
    }

    return spiTransferError;
}


// *****************************************************************************
// *****************************************************************************


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************
// *****************************************************************************
// *****************************************************************************


//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//************************************************************************************************************************************************

//
// *****************************************************************************
// *****************************************************************************
// Section: Miscellaneous


int8_t DRV_CANFDSPI_FifoIndexGet(CANFDSPI_MODULE_ID index,
        CAN_FIFO_CHANNEL channel, uint8_t* mi)
{
    int8_t spiTransferError = 0;
    uint16_t a = 0;

    // Read Status register
    uint8_t b = 0;
    a = cREGADDR_CiFIFOSTA + (channel * CiFIFO_OFFSET);
    a += 1; // byte[1]

    spiTransferError = DRV_CANFDSPI_ReadByte(index, a, &b);
    if (spiTransferError) {
        return -1;
    }

    // Update data
    *mi = b & 0x1f;

    return spiTransferError;
}


